{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelli-Doc AI</title>
    <link rel="icon" type="image/png" href="{% static 'favicon.png' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <h2>Upload New Document</h2>
            <div class="upload-btn-wrapper">
                <button class="btn">Choose File</button>
                <input type="file" id="file-input" accept=".pdf,.docx,.xlsx,.pptx" />
            </div>
            <div class="sidebar-header">
                <h2>Recent Documents</h2>
                <button id="clear-session-btn" class="clear-btn" title="Clear chat only">
                    <i class="fas fa-broom"></i> Clear Chat
                </button>
            </div>
           <!-- Document list with conditional rendering -->
            <div id="doc-list-container">
                <ul id="doc-list"></ul>
                <div id="no-documents-message" style="display: none;">
                    <p>No documents uploaded yet. Upload your first document to get started!</p>
                </div>
            </div>
            <form action="/clear-session/" method="post" id="clear-session-form">
                {% csrf_token %}
                <button type="submit" id="clear-session" class="clear-btn" title="Clear Chat & Session">
                    <i class="fas fa-broom"></i> Clear Session
                </button>
            </form>
        </aside>
        <main class="chat-panel">
            <header class="chat-header"><h1>Intelli-Doc AI 🤖</h1></header>
            <div class="welcome-message" id="welcome-message">   
                <h4>Welcome!</h4>
                <p>Upload a document and select it from the sidebar to begin.</p>
            </div>
            <div class="chat-box" id="chat-box">
                <div class="placeholder" id="placeholder">

                </div>
            </div>
            <div class="input-area">
                <input id="question-input" placeholder="Ask a question about the selected document..." disabled>
                <button id="send-btn" disabled>
                    <span class="icon send-icon"><i class="fas fa-paper-plane"></i></span>
                    <span class="icon stop-icon"><i class="fas fa-stop"></i></span>
                </button>
            </div>
        </main>
    </div>

<script>
// --- STATE MANAGEMENT ---
const state = {
    recentDocuments: [],
    activeDocumentId: null,
    chatHistories: {},
    isProcessing: false,
    abortController: null
};

// --- DOM ELEMENTS ---
const fileInput = document.getElementById('file-input');
const docList = document.getElementById('doc-list');
const chatBox = document.getElementById('chat-box');
const questionInput = document.getElementById('question-input');
const sendBtn = document.getElementById('send-btn');
const placeholder = document.getElementById('placeholder');
const uploadButton = document.querySelector('.upload-btn-wrapper .btn');
const noDocumentsMsg = document.getElementById('no-documents-message');
const sidebarHeader = document.querySelector('.sidebar-header');

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/documents/');
        
        // Condition: Handle API response success/failure
        if (response.ok) {
            state.recentDocuments = await response.json();
        } else {
            console.error('Failed to fetch documents:', response.status);
            state.recentDocuments = [];
        }

        // --- LOAD CHATS FROM LOCALSTORAGE ---
        const savedChats = localStorage.getItem('chatHistories');
        if (savedChats) {
            try {
                const parsedChats = JSON.parse(savedChats);
                // Additional condition: only keep chats for existing documents
                if (state.recentDocuments && state.recentDocuments.length > 0) {
                    const syncedChats = {};
                    state.recentDocuments.forEach(doc => {
                        if (parsedChats[doc.id]) {
                            syncedChats[doc.id] = parsedChats[doc.id];
                        }
                    });
                    state.chatHistories = syncedChats;
                }
            } catch (e) {
                console.error('Error parsing saved chats:', e);
                state.chatHistories = {};
            }
        }
        
        // Render the initial state of the application
        render();

    } catch (error) {
        console.error("Initialization Error:", error);
        state.recentDocuments = [];
        render();
    }
});

// --- EVENT LISTENERS ---
fileInput.addEventListener('change', handleUpload);
sendBtn.addEventListener('click', handleSendButtonClick);
questionInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (state.isProcessing) {
            stopGeneration();
        } else {
            handleQuery();
        }
    }
});

// --- CORE LOGIC ---
function handleSendButtonClick() {
    if (state.isProcessing) {
        stopGeneration();
    } else {
        handleQuery();
    }
}

async function handleUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (state.recentDocuments.length >= 10) {
        const oldestDoc = state.recentDocuments[0];
        const confirmed = confirm(`You have reached the 10-document limit.\n\nUploading this will delete the oldest one: "${oldestDoc.name}".\n\nDo you want to continue?`);
        if (!confirmed) {
            fileInput.value = '';
            return;
        }
    }
    
    const originalBtnText = uploadButton.textContent;
    uploadButton.textContent = 'Processing...';
    uploadButton.disabled = true;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const uploadResponse = await fetch('/api/upload/', { method: 'POST', body: formData });
        if (!uploadResponse.ok) throw new Error(`Upload failed with status ${uploadResponse.status}`);
        const newDoc = await uploadResponse.json();

        const docsResponse = await fetch('/api/documents/');
        if (!docsResponse.ok) throw new Error('Failed to fetch updated documents.');
        state.recentDocuments = await docsResponse.json();

        switchDocument(newDoc.document_id);
    } catch (error) {
        alert(`Error: ${error.message}`);
    } finally {
        uploadButton.textContent = originalBtnText;
        uploadButton.disabled = false;
        fileInput.value = '';
    }
}

function switchDocument(docId) {
    if (state.activeDocumentId === docId) return;

    state.activeDocumentId = docId;

    if (!state.chatHistories[docId]) {
        const doc = state.recentDocuments.find(d => d.id === docId);
        const welcomeMessage = `Now chatting with "${doc.name}". Ask me anything!`;
        state.chatHistories[docId] = [{ text: welcomeMessage, sender: 'ai' }];
    }

    render();
}

// --- COMPLETE SESSION CLEARANCE FUNCTION ---
async function handleClearSession(event) {
    // Prevent default form submission (page reload)
   // Prevent default form submission (page reload)
    event.preventDefault();
    
    // Show confirmation dialog
    const isConfirmed = confirm("🚨 Are you sure you want to clear the entire session?\n\nThis will:\n• Delete all uploaded documents\n• Clear all chat history\n• Remove all conversation data\n• Reset the application to initial state\n\nThis action cannot be undone!");
    
    // If user cancels, stop here
    if (!isConfirmed) {
        console.log('Session clearance cancelled by user');
        return;
    }
    
    console.log('Starting complete session clearance...');
    
    try {

        // Show loading state
        const clearBtn = document.getElementById('clear-session');
        const originalHtml = clearBtn.innerHTML;
        clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
        clearBtn.disabled = true;

        // 1. CLEAR ALL FRONTEND STATE VARIABLES
        console.log('Clearing frontend state variables...');
        
        // Reset all state variables to false/null/empty
        state.recentDocuments = [];
        state.activeDocumentId = null;
        state.chatHistories = {};
        state.isProcessing = false;
        
        // Abort any ongoing requests
        if (state.abortController) {
            state.abortController.abort();
            state.abortController = null;
        }

        // 2. DELETE ALL UPLOADED FILES FROM SERVER
        console.log('Deleting uploaded files from server...');
        try {
            const deleteResponse = await fetch('/api/delete-all-documents/', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!deleteResponse.ok) {
                console.warn('File deletion failed, but continuing with session clearance');
            }
        } catch (fileError) {
            console.warn('File deletion error:', fileError);
            // Continue with session clearance even if file deletion fails
        }

        // 3. CLEAR UI COMPONENTS
        console.log('Clearing UI components...');
        
        // Clear chat box
        chatBox.innerHTML = '';
        
        // Show placeholder
        placeholder.style.display = 'block';
        
        // Reset input field
        questionInput.value = '';
        questionInput.disabled = true;
        
        // Disable send button
        sendBtn.disabled = true;
        updateSendButtonState();
        
        // Clear document list
        const docList = document.getElementById('doc-list');
        docList.innerHTML = '';
        
        // Show empty documents message
        const noDocumentsMsg = document.getElementById('no-documents-message');
        if (noDocumentsMsg) {
            noDocumentsMsg.style.display = 'block';
        }
        
        // Remove active classes
        const activeItems = document.querySelectorAll('.active');
        activeItems.forEach(item => item.classList.remove('active'));

        // 4. CLEAR ALL STORAGE
        console.log('Clearing storage...');
        
        // Clear localStorage
        localStorage.removeItem('chatHistories');
        
        // Clear sessionStorage
        sessionStorage.clear();
        
        // Clear cookies related to the application
        document.cookie.split(';').forEach(cookie => {
            const cookieName = cookie.split('=')[0].trim();
            if (cookieName.includes('session') || cookieName.includes('doc')) {
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            }
        });

        // 5. CLEAR BACKEND SESSION
        console.log('Clearing backend session...');
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch('/clear-session/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'session-message success';
            successMsg.innerHTML = '✅ Complete session cleared successfully! All files and data removed.';
            chatBox.appendChild(successMsg);
            
            // Remove message after 4 seconds
            setTimeout(() => {
                if (successMsg.parentNode) {
                    successMsg.parentNode.removeChild(successMsg);
                }
            }, 4000);
            
            console.log('Complete session clearance successful');
        } else {
            throw new Error(result.message);
        }

    } catch (error) {
        console.error('Error during complete session clearance:', error);
        
        // Show error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'session-message error';
        errorMsg.innerHTML = '❌ Error clearing session. Some data may still remain.';
        chatBox.appendChild(errorMsg);
        
        // Remove message after 4 seconds
        setTimeout(() => {
            if (errorMsg.parentNode) {
                errorMsg.parentNode.removeChild(errorMsg);
            }
        }, 4000);
        
    } finally {
        // Restore clear button state
        const clearBtn = document.getElementById('clear-session');
        if (clearBtn) {
            clearBtn.innerHTML = '<i class="fas fa-broom"></i> Clear Session';
            clearBtn.disabled = false;
        }
        
        // Final UI update
        render();
        
        console.log('Session clearance process completed');
    }
}

// --- ADD EVENT LISTENER TO THE FORM ---
document.addEventListener('DOMContentLoaded', function() {
    const clearSessionForm = document.getElementById('clear-session-form');
    if (clearSessionForm) {
        clearSessionForm.addEventListener('submit', handleClearSession);
        console.log('Clear session form event listener added');
    }
});

// --- URL PATTERN FOR FILE DELETION (add to urls.py) ---
/*
path('api/delete-all-documents/', views.delete_all_documents, name='delete_all_documents'),
*/

async function handleQuery() {
    const question = questionInput.value.trim();
    if (!question || !state.activeDocumentId || state.isProcessing) return;

    // Create new AbortController for this request
    state.abortController = new AbortController();
    state.isProcessing = true;
    updateSendButtonState();

    addMessage(question, 'user');
    questionInput.value = '';
    addLoader();
    
    try {
        const response = await fetch('/api/query/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ document_id: state.activeDocumentId, question: question }),
            signal: state.abortController.signal
        });

        if (!response.ok) throw new Error(`Query failed with status ${response.status}`);

        const data = await response.json();
        removeLoader();
        addMessage(data.answer, 'ai');
    } catch (error) {
        removeLoader();
        if (error.name === 'AbortError') {
            addMessage("You stopped this response", 'ai', 'stopped');
        } else {
            addMessage(`Sorry, an error occurred: ${error.message}`, 'ai');
        }
    } finally {
        state.isProcessing = false;
        state.abortController = null;
        updateSendButtonState();
    }
}

function stopGeneration() {
    if (state.abortController) {
        state.abortController.abort();
    }
    state.isProcessing = false;
    updateSendButtonState();
}

function updateSendButtonState() {
    if (state.isProcessing) {
        sendBtn.classList.add('stop-mode');
        sendBtn.title = "Stop generating";
    } else {
        sendBtn.classList.remove('stop-mode');
        sendBtn.title = "Send message";
    }
}

// --- SESSION CLEAR FUNCTION ---
function clearSession() {
    // Condition: Only clear if there's something to clear
    if (state.activeDocumentId || Object.keys(state.chatHistories).length > 0) {
        state.chatHistories = {};
        state.activeDocumentId = false;
        
        localStorage.removeItem('chatHistories');
        
        // Show confirmation message
        const confirmation = document.createElement('div');
        confirmation.textContent = 'Chat session cleared!';
        confirmation.style.cssText = 'background: #4CAF50; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;';
        chatBox.appendChild(confirmation);
        
        setTimeout(() => {
            if (confirmation.parentNode) {
                confirmation.parentNode.removeChild(confirmation);
            }
        }, 2000);
        
        // Re-render to update UI
        render();
    }
}

// --- UI RENDERING WITH CONDITIONAL LOGIC ---
function render() {
    renderSidebar();
    renderChat();
    
    // Condition: Enable/disable input based on active document and processing state
    const hasActiveDoc = !!state.activeDocumentId;
    
    if (hasActiveDoc && !state.isProcessing) {
        questionInput.disabled = false;
        sendBtn.disabled = false;
    } else {
        questionInput.disabled = true;
        sendBtn.disabled = true;
    }
    
    updateSendButtonState();
}

function renderSidebar() {
    const docList = document.getElementById('doc-list');
    const noDocumentsMsg = document.getElementById('no-documents-message');
    
    // Clear existing list and buttons
    docList.innerHTML = '';
    
    // Condition 1: Show/hide clear session button based on active document
    if (state.activeDocumentId || Object.keys(state.chatHistories).length > 0) {
        if (!document.getElementById('clear-session-btn')) {
            const clearBtn = document.createElement('button');
            clearBtn.id = 'clear-session-btn';
            clearBtn.className = 'clear-btn';
            clearBtn.title = 'Clear chat session';
            clearBtn.innerHTML = '<i class="fas fa-broom"></i> Clear Chat';
            clearBtn.addEventListener('click', clearSession);
            sidebarHeader.appendChild(clearBtn);
        }
    } else {
        const clearBtn = document.getElementById('clear-session-btn');
        if (clearBtn) {
            clearBtn.remove();
        }
    }
    
    // Condition 2: Show documents list or empty state message
    if (state.recentDocuments && state.recentDocuments.length > 0) {
        docList.style.display = 'block';
        noDocumentsMsg.style.display = 'none';
        
        // Render in reverse order (most recent first) - KEY CHANGE
        for (let i = state.recentDocuments.length - 1; i >= 0; i--) {
            const doc = state.recentDocuments[i];
            const li = document.createElement('li');
            li.dataset.id = doc.id;
            li.textContent = doc.name;
            
            if (doc.id === state.activeDocumentId) {
                li.classList.add('active');
            }
            
            li.addEventListener('click', () => switchDocument(doc.id));
            docList.appendChild(li);
        }
    } else {
        docList.style.display = 'none';
        noDocumentsMsg.style.display = 'block';
    }
}

function renderChat() {
    chatBox.innerHTML = '';
    
    // Condition: Show chat or placeholder based on active document
    if (state.activeDocumentId && state.chatHistories[state.activeDocumentId]) {
        // Hide placeholder, show chat messages
        placeholder.style.display = 'none';
        
        state.chatHistories[state.activeDocumentId].forEach(msg => {
            const messageElement = createMessageElement(msg.text, msg.sender, msg.type);
            chatBox.appendChild(messageElement);
        });
    } else {
        // Show placeholder, hide chat messages
        placeholder.style.display = 'block';
    }
    
    chatBox.scrollTop = chatBox.scrollHeight;
}

// --- UI HELPER FUNCTIONS ---
function addMessage(text, sender, type = 'normal') {
    if (state.activeDocumentId) {
        state.chatHistories[state.activeDocumentId].push({ text, sender, type });
        
        // --- SAVE CHATS TO LOCALSTORAGE ---
        localStorage.setItem('chatHistories', JSON.stringify(state.chatHistories));
    }
    
    const messageElement = createMessageElement(text, sender, type);
    chatBox.appendChild(messageElement);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function createMessageElement(text, sender, type = 'normal') {
    const element = document.createElement('div');
    element.classList.add('message', `${sender}-message`);
    
    if (type === 'stopped') {
        element.classList.add('stopped-message');
    } else if (type === 'thinking') {
        element.classList.add('thinking-message');
    }
    
    element.textContent = text;
    return element;
}

function addLoader() {
    const loader = createMessageElement('Thinking...', 'ai', 'thinking');
    loader.id = 'loader';
    chatBox.appendChild(loader);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function removeLoader() {
    const loader = document.getElementById('loader');
    if (loader) loader.remove();
}
</script>
</body>
</html>